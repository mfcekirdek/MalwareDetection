#!/usr/bin/python
import os
from cuckoo.core.database import Database
from cuckoo.misc import decide_cwd
from shutil import copyfile
import json

# decide_cwd("~/.cuckoo")
# db = Database()
# db.connect()
# db.add_path(file_path="/home/fatihc/MachineLearning/MalwareDetectionWithAI/CuckooController/EE3104ED",timeout=120,priority=2,machine="win7-64",memory=False)
# db.add_url("http://www.cuckoosandbox.org")

class Controller:
    def __init__(self,cwdPath="~/.cuckoo"):
        decide_cwd(cwdPath)
        self.connectToCuckoo()

    def connectToCuckoo(self):
        self.db = Database()
        self.db.connect()

    def submitTasksFromDir(self,path):
        # benign_1054_files_path = "/home/fatihc/MachineLearning/MalwareDetectionWithAI/samples/malicious/1KSample"

        for file in os.listdir(path):
            file_path = (os.path.join(path, file))
            self.db.add_path(file_path=file_path, timeout=120, priority=2, machine="win7-64", memory=False)

    def extractReportsAndPcapsFromAnalyses(self,dirs="/home/fatihc/MachineLearning/MalwareDetectionWithAI/data/CuckooResults",
                                           targetDir="/home/fatihc/MachineLearning/MalwareDetectionWithAI/data/ReportAndPcap/Benign"):

        for dir in os.listdir(dirs):
            reportPath = os.path.join(dirs,dir,"reports","report.json")
            dumpPath = os.path.join(dirs,dir,"dump.pcap")

            data = json.load(open(reportPath))
            fileName = data["target"]["file"]["name"]

            copyfile(reportPath,os.path.join(targetDir,fileName + "_report.json"))
            copyfile(dumpPath,os.path.join(targetDir,fileName + "_dump.pcap"))

            # print reportPath
            # print dumpPath

if __name__ == '__main__':
   controller = Controller()
   # controller.submitTasksFromDir("/home/fatihc/MachineLearning/MalwareDetectionWithAI/samples/malicious/1KSample")
   controller.extractReportsAndPcapsFromAnalyses("/home/fatihc/MachineLearning/MalwareDetectionWithAI/data/CuckooResults","/home/fatihc/MachineLearning/MalwareDetectionWithAI/data/ReportAndPcap/Benign")
